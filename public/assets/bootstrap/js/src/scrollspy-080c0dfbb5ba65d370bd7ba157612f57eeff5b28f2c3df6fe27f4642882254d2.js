import $ from"jquery";import Util from"./util";const ScrollSpy=(t=>{const e="scrollspy",s="4.1.3",l="bs.scrollspy",i=`.${l}`,o=".data-api",r=t.fn[e],n={offset:10,method:"auto",target:""},c={offset:"number",method:"string",target:"(string|element)"},h={ACTIVATE:`activate${i}`,SCROLL:`scroll${i}`,LOAD_DATA_API:`load${i}${o}`},a={DROPDOWN_ITEM:"dropdown-item",DROPDOWN_MENU:"dropdown-menu",ACTIVE:"active"},_={DATA_SPY:'[data-spy="scroll"]',ACTIVE:".active",NAV_LIST_GROUP:".nav, .list-group",NAV_LINKS:".nav-link",NAV_ITEMS:".nav-item",LIST_ITEMS:".list-group-item",DROPDOWN:".dropdown",DROPDOWN_ITEMS:".dropdown-item",DROPDOWN_TOGGLE:".dropdown-toggle"},f={OFFSET:"offset",POSITION:"position"};class g{constructor(e,s){this._element=e,this._scrollElement="BODY"===e.tagName?window:e,this._config=this._getConfig(s),this._selector=`${this._config.target} ${_.NAV_LINKS},`+`${this._config.target} ${_.LIST_ITEMS},`+`${this._config.target} ${_.DROPDOWN_ITEMS}`,this._offsets=[],this._targets=[],this._activeTarget=null,this._scrollHeight=0,t(this._scrollElement).on(h.SCROLL,t=>this._process(t)),this.refresh(),this._process()}static get VERSION(){return s}static get Default(){return n}refresh(){const e=this._scrollElement===this._scrollElement.window?f.OFFSET:f.POSITION,s="auto"===this._config.method?e:this._config.method,l=s===f.POSITION?this._getScrollTop():0;this._offsets=[],this._targets=[],this._scrollHeight=this._getScrollHeight(),[].slice.call(document.querySelectorAll(this._selector)).map(e=>{let i;const o=Util.getSelectorFromElement(e);if(o&&(i=document.querySelector(o)),i){const e=i.getBoundingClientRect();if(e.width||e.height)return[t(i)[s]().top+l,o]}return null}).filter(t=>t).sort((t,e)=>t[0]-e[0]).forEach(t=>{this._offsets.push(t[0]),this._targets.push(t[1])})}dispose(){t.removeData(this._element,l),t(this._scrollElement).off(i),this._element=null,this._scrollElement=null,this._config=null,this._selector=null,this._offsets=null,this._targets=null,this._activeTarget=null,this._scrollHeight=null}_getConfig(s){if("string"!=typeof(s={...n,..."object"==typeof s&&s?s:{}}).target){let l=t(s.target).attr("id");l||(l=Util.getUID(e),t(s.target).attr("id",l)),s.target=`#${l}`}return Util.typeCheckConfig(e,s,c),s}_getScrollTop(){return this._scrollElement===window?this._scrollElement.pageYOffset:this._scrollElement.scrollTop}_getScrollHeight(){return this._scrollElement.scrollHeight||Math.max(document.body.scrollHeight,document.documentElement.scrollHeight)}_getOffsetHeight(){return this._scrollElement===window?window.innerHeight:this._scrollElement.getBoundingClientRect().height}_process(){const t=this._getScrollTop()+this._config.offset,e=this._getScrollHeight(),s=this._config.offset+e-this._getOffsetHeight();if(this._scrollHeight!==e&&this.refresh(),t>=s){const t=this._targets[this._targets.length-1];this._activeTarget!==t&&this._activate(t)}else{if(this._activeTarget&&t<this._offsets[0]&&this._offsets[0]>0)return this._activeTarget=null,void this._clear();for(let e=this._offsets.length;e--;){this._activeTarget!==this._targets[e]&&t>=this._offsets[e]&&("undefined"==typeof this._offsets[e+1]||t<this._offsets[e+1])&&this._activate(this._targets[e])}}}_activate(e){this._activeTarget=e,this._clear();let s=this._selector.split(",");s=s.map(t=>`${t}[data-target="${e}"],`+`${t}[href="${e}"]`);const l=t([].slice.call(document.querySelectorAll(s.join(","))));l.hasClass(a.DROPDOWN_ITEM)?(l.closest(_.DROPDOWN).find(_.DROPDOWN_TOGGLE).addClass(a.ACTIVE),l.addClass(a.ACTIVE)):(l.addClass(a.ACTIVE),l.parents(_.NAV_LIST_GROUP).prev(`${_.NAV_LINKS}, ${_.LIST_ITEMS}`).addClass(a.ACTIVE),l.parents(_.NAV_LIST_GROUP).prev(_.NAV_ITEMS).children(_.NAV_LINKS).addClass(a.ACTIVE)),t(this._scrollElement).trigger(h.ACTIVATE,{relatedTarget:e})}_clear(){const e=[].slice.call(document.querySelectorAll(this._selector));t(e).filter(_.ACTIVE).removeClass(a.ACTIVE)}static _jQueryInterface(e){return this.each(function(){let s=t(this).data(l);if(s||(s=new g(this,"object"==typeof e&&e),t(this).data(l,s)),"string"==typeof e){if("undefined"==typeof s[e])throw new TypeError(`No method named "${e}"`);s[e]()}})}}return t(window).on(h.LOAD_DATA_API,()=>{const e=[].slice.call(document.querySelectorAll(_.DATA_SPY));for(let s=e.length;s--;){const l=t(e[s]);g._jQueryInterface.call(l,l.data())}}),t.fn[e]=g._jQueryInterface,t.fn[e].Constructor=g,t.fn[e].noConflict=function(){return t.fn[e]=r,g._jQueryInterface},g})($);export default ScrollSpy;